{"version":3,"sources":["ClippingBoxes.tsx","App.tsx","index.tsx"],"names":["ClippingBoxes","currentFrame","boxesProps","id","image","map","boxProps","crop","x","srcX","y","srcY","width","srcWidth","height","srcHeight","showX","showY","showWidth","showHeight","stroke","strokeWidth","draggable","key","videoConstraints","facingMode","layoutSize","createCanvas","size","canvas","document","createElement","SelectionRect","beginPos","endPos","fill","opacity","App","useState","baseCanvas","setBaseCanvas","frameInterval","setFrameInterval","setBoxesProps","mouseDownPos","setMouseDownPos","dragging","setDragging","cameraRef","useRef","inputAreaRef","useEffect","setInterval","ctx","getContext","drawImage","current","video","getImageData","l","data","length","i","grayscale","makeGrayscale","putImageData","refreshFrame","clearInterval","getRelativePointerPosition","node","transform","getAbsoluteTransform","copy","invert","pos","getStage","getPointerPosition","point","className","ref","audio","style","position","onMouseDown","onMouseUp","relativePos","ReactDOM","render","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.a0d64f7b.chunk.js","sourcesContent":["import React from \"react\";\r\nimport { Layer, Image } from \"react-konva\";\r\n\r\nexport type BoxProps = {\r\n  key: number;\r\n  srcX: number;\r\n  srcY: number;\r\n  srcWidth: number;\r\n  srcHeight: number;\r\n  showX: number;\r\n  showY: number;\r\n  showWidth: number;\r\n  showHeight: number;\r\n};\r\n\r\nconst ClippingBoxes: React.FC<{\r\n  currentFrame: CanvasImageSource;\r\n  boxesProps: BoxProps[];\r\n}> = ({ currentFrame, boxesProps }) => {\r\n  return (\r\n    <Layer>\r\n      <Image id=\"baseCanvas\" image={currentFrame} />\r\n      {(() =>\r\n        boxesProps.map((boxProps) => (\r\n          <Image\r\n            key={boxProps.key}\r\n            image={currentFrame}\r\n            crop={{\r\n              x: boxProps.srcX,\r\n              y: boxProps.srcY,\r\n              width: boxProps.srcWidth,\r\n              height: boxProps.srcHeight,\r\n            }}\r\n            x={boxProps.showX}\r\n            y={boxProps.showY}\r\n            width={boxProps.showWidth}\r\n            height={boxProps.showHeight}\r\n            stroke={\"black\"}\r\n            strokeWidth={10}\r\n            draggable\r\n          />\r\n        )))()}\r\n    </Layer>\r\n  );\r\n};\r\n\r\nexport default ClippingBoxes;\r\n","import React, { useState, useRef, useEffect } from \"react\";\r\nimport Webcam from \"react-webcam\";\r\nimport { Layer, Stage, Rect } from \"react-konva\";\r\nimport ClippingBoxes, { BoxProps } from \"./ClippingBoxes\";\r\nimport { Vector2d } from \"konva/types/types\";\r\nimport Konva from \"konva\";\r\n\r\ntype RectSize = {\r\n  width: number;\r\n  height: number;\r\n};\r\n\r\nconst videoConstraints = {\r\n  width: 1280,\r\n  height: 720,\r\n  facingMode: \"user\",\r\n};\r\n\r\nconst layoutSize: RectSize = {\r\n  ...videoConstraints,\r\n};\r\n\r\nconst createCanvas = (size: RectSize) => {\r\n  const canvas = document.createElement(\"canvas\");\r\n  canvas.width = size.width;\r\n  canvas.height = size.height;\r\n\r\n  return canvas;\r\n};\r\n\r\nconst makeGrayscale = (image: ImageData) => {\r\n  const l = image.data.length / 4;\r\n  for (let i = 0; i < l; i++) {\r\n    const grayscale =\r\n      image.data[i * 4 + 0] * 0.299 +\r\n      image.data[i * 4 + 1] * 0.587 +\r\n      image.data[i * 4 + 2] * 0.114;\r\n\r\n    image.data[i * 4 + 0] = grayscale;\r\n    image.data[i * 4 + 1] = grayscale;\r\n    image.data[i * 4 + 2] = grayscale;\r\n  }\r\n};\r\n\r\nconst SelectionRect: React.FC<{\r\n  beginPos: Vector2d;\r\n  endPos: Vector2d;\r\n}> = ({ beginPos, endPos }) => {\r\n  return (\r\n    <Rect\r\n      x={beginPos.x}\r\n      y={beginPos.y}\r\n      width={endPos.x - beginPos.x}\r\n      height={endPos.y - beginPos.y}\r\n      fill={\"blue\"}\r\n      stroke={\"red\"}\r\n      opacity={0.2}\r\n    />\r\n  );\r\n};\r\n\r\nconst App: React.FC = () => {\r\n  const [baseCanvas, setBaseCanvas] = useState(createCanvas(layoutSize));\r\n  const [frameInterval, setFrameInterval] = useState<NodeJS.Timeout>();\r\n  const [boxesProps, setBoxesProps] = useState<BoxProps[]>([]);\r\n  const [mouseDownPos, setMouseDownPos] = useState<Vector2d>({ x: 0, y: 0 });\r\n  const [dragging, setDragging] = useState<Boolean>(false);\r\n\r\n  const cameraRef = useRef<Webcam>(null);\r\n  const inputAreaRef = useRef<Konva.Stage>(null);\r\n\r\n  const refreshFrame = () => {\r\n    const ctx = createCanvas(layoutSize).getContext(\"2d\")!;\r\n    ctx.drawImage(cameraRef.current!.video!, 0, 0);\r\n\r\n    const image = ctx.getImageData(0, 0, layoutSize.width, layoutSize.height);\r\n    makeGrayscale(image);\r\n    ctx.putImageData(image, 0, 0);\r\n\r\n    setBaseCanvas(ctx.canvas);\r\n  };\r\n\r\n  useEffect(() => {\r\n    setFrameInterval(setInterval(() => refreshFrame(), 1000 / 30));\r\n\r\n    return () => {\r\n      clearInterval(frameInterval!);\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  const getRelativePointerPosition = () => {\r\n    const node = inputAreaRef.current!;\r\n    const transform = node.getAbsoluteTransform().copy();\r\n    transform.invert();\r\n    const pos = node.getStage().getPointerPosition()!;\r\n\r\n    return transform.point(pos);\r\n  };\r\n\r\n  return (\r\n    <section className=\"App\">\r\n      <Webcam\r\n        id=\"camera\"\r\n        ref={cameraRef}\r\n        audio={false}\r\n        videoConstraints={videoConstraints}\r\n        width={layoutSize.width}\r\n        height={layoutSize.height}\r\n        style={{ position: \"absolute\" }}\r\n      />\r\n      <Stage\r\n        className=\"inputArea\"\r\n        width={layoutSize.width}\r\n        height={layoutSize.height}\r\n        ref={inputAreaRef}\r\n        onMouseDown={() => {\r\n          setMouseDownPos(getRelativePointerPosition());\r\n          setDragging(true);\r\n        }}\r\n        onMouseUp={() => {\r\n          const relativePos = getRelativePointerPosition();\r\n          setBoxesProps([\r\n            ...boxesProps,\r\n            {\r\n              key: boxesProps.length,\r\n              srcX: relativePos.x,\r\n              srcY: relativePos.y,\r\n              srcWidth: mouseDownPos.x - relativePos.x,\r\n              srcHeight: mouseDownPos.y - relativePos.y,\r\n              showX: relativePos.x,\r\n              showY: relativePos.y,\r\n              showWidth: mouseDownPos.x - relativePos.x,\r\n              showHeight: mouseDownPos.y - relativePos.y,\r\n            },\r\n          ]);\r\n          setDragging(false);\r\n        }}\r\n      >\r\n        <Layer>\r\n          {dragging ? (\r\n            <SelectionRect\r\n              beginPos={mouseDownPos}\r\n              endPos={getRelativePointerPosition()}\r\n            />\r\n          ) : null}\r\n        </Layer>\r\n      </Stage>\r\n      <Stage\r\n        className=\"outputArea\"\r\n        width={layoutSize.width}\r\n        height={layoutSize.height}\r\n      >\r\n        <ClippingBoxes currentFrame={baseCanvas} boxesProps={boxesProps} />\r\n      </Stage>\r\n    </section>\r\n  );\r\n};\r\n\r\nexport default App;\r\n","import React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport App from \"./App\";\r\n\r\nReactDOM.render(\r\n  <React.StrictMode>\r\n    <App />\r\n  </React.StrictMode>,\r\n  document.getElementById(\"root\")\r\n);\r\n"],"sourceRoot":""}